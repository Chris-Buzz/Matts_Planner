{% extends "base.html" %}

{% block title %}Shopping List - Task Tracker{% endblock %}

{% block content %}
<div class="dashboard">
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-clock"></i> Task Tracker
        </div>
        <div class="nav-links">
            <a href="{{ url_for('dashboard') }}" class="nav-link">
                <i class="fas fa-calendar-alt"></i> Tasks
            </a>
            <a href="{{ url_for('shopping_list') }}" class="nav-link active">
                <i class="fas fa-shopping-cart"></i> Shopping List
            </a>
        </div>
        <div class="nav-user">
            <span>Welcome, <strong>{{ username }}</strong></span>
            <div class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-logout">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </nav>
    
    <div class="dashboard-content shopping-list-page">
        <div class="shopping-header">
            <h1><i class="fas fa-shopping-cart"></i> Shopping List</h1>
            <div class="shopping-actions">
                <button class="btn btn-primary" id="addItemBtn">
                    <i class="fas fa-plus"></i> Add Item
                </button>
                <button class="btn btn-danger" id="clearPurchasedBtn">
                    <i class="fas fa-trash"></i> Clear Purchased
                </button>
            </div>
        </div>
        
        <div class="filter-tabs">
            <button class="tab-btn active" data-filter="all">
                <i class="fas fa-list"></i> All Items
            </button>
            <button class="tab-btn" data-filter="pending">
                <i class="fas fa-shopping-basket"></i> To Buy
            </button>
            <button class="tab-btn" data-filter="purchased">
                <i class="fas fa-check-circle"></i> Purchased
            </button>
        </div>
        
        <div class="shopping-stats">
            <div class="stat-badge">
                <span id="totalItems">0</span>
                <div>Total Items</div>
            </div>
            <div class="stat-badge">
                <span id="pendingItems">0</span>
                <div>To Buy</div>
            </div>
            <div class="stat-badge">
                <span id="purchasedItems">0</span>
                <div>Purchased</div>
            </div>
        </div>
        
        <div class="shopping-list-container">
            <div id="shoppingList"></div>
        </div>
    </div>
</div>

<!-- Add/Edit Item Modal -->
<div id="itemModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Shopping Item</h2>
            <span class="close">&times;</span>
        </div>
        
        <form id="itemForm">
            <input type="hidden" id="itemId">
            
            <div class="form-group">
                <label for="itemName">
                    <i class="fas fa-tag"></i> Item Name
                </label>
                <input type="text" id="itemName" required placeholder="e.g., Milk, Bread, Apples">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="itemQuantity">
                        <i class="fas fa-sort-numeric-up"></i> Quantity
                    </label>
                    <input type="text" id="itemQuantity" placeholder="e.g., 2, 500g, 1 dozen">
                </div>
                
                <div class="form-group">
                    <label for="itemCategory">
                        <i class="fas fa-folder"></i> Category
                    </label>
                    <select id="itemCategory">
                        <option value="groceries">Groceries</option>
                        <option value="produce">Produce</option>
                        <option value="dairy">Dairy</option>
                        <option value="meat">Meat</option>
                        <option value="bakery">Bakery</option>
                        <option value="household">Household</option>
                        <option value="personal">Personal Care</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label for="itemNotes">
                    <i class="fas fa-sticky-note"></i> Notes (Optional)
                </label>
                <textarea id="itemNotes" rows="2" placeholder="Any special instructions or notes..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Item
                </button>
            </div>
        </form>
    </div>
</div>

<div id="message" class="message"></div>
{% endblock %}

{% block extra_js %}
<script>
let currentFilter = 'all';
let editingItemId = null;

// Modal controls
const modal = document.getElementById('itemModal');
const addItemBtn = document.getElementById('addItemBtn');
const closeBtn = document.querySelector('.close');
const cancelBtn = document.getElementById('cancelBtn');

addItemBtn.onclick = () => {
    editingItemId = null;
    document.getElementById('modalTitle').textContent = 'Add Shopping Item';
    document.getElementById('itemForm').reset();
    modal.style.display = 'flex';
};

closeBtn.onclick = () => modal.style.display = 'none';
cancelBtn.onclick = () => modal.style.display = 'none';

window.onclick = (e) => {
    if (e.target == modal) modal.style.display = 'none';
};

// Load shopping items
async function loadItems(filter = 'all') {
    try {
        const response = await fetch(`/api/shopping-items?filter=${filter}`);
        const items = await response.json();
        
        updateStats(items);
        
        const shoppingList = document.getElementById('shoppingList');
        
        if (items.length === 0) {
            shoppingList.innerHTML = '<div class="no-items"><i class="fas fa-shopping-basket"></i><p>No items in your shopping list</p></div>';
            return;
        }
        
        // Group items by category
        const grouped = items.reduce((acc, item) => {
            if (!acc[item.category]) acc[item.category] = [];
            acc[item.category].push(item);
            return acc;
        }, {});
        
        shoppingList.innerHTML = Object.entries(grouped).map(([category, categoryItems]) => `
            <div class="category-section">
                <h3 class="category-title">
                    <i class="fas fa-folder"></i> ${category.charAt(0).toUpperCase() + category.slice(1)}
                </h3>
                <div class="items-grid">
                    ${categoryItems.map(item => `
                        <div class="shopping-item ${item.is_purchased ? 'purchased' : ''}">
                            <div class="item-checkbox">
                                <input type="checkbox" 
                                       ${item.is_purchased ? 'checked' : ''} 
                                       onchange="toggleItem(${item.id})"
                                       id="item-${item.id}">
                                <label for="item-${item.id}"></label>
                            </div>
                            <div class="item-details">
                                <div class="item-name">${item.item_name}</div>
                                <div class="item-meta">
                                    <span class="item-quantity">
                                        <i class="fas fa-boxes"></i> ${item.quantity}
                                    </span>
                                    ${item.notes ? `<span class="item-notes" title="${item.notes}"><i class="fas fa-sticky-note"></i></span>` : ''}
                                </div>
                            </div>
                            <div class="item-actions">
                                <button class="btn-icon" onclick="editItem(${item.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon btn-delete" onclick="deleteItem(${item.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading items:', error);
        showMessage('Error loading shopping list', 'error');
    }
}

function updateStats(items) {
    const total = items.length;
    const purchased = items.filter(i => i.is_purchased).length;
    const pending = total - purchased;
    
    document.getElementById('totalItems').textContent = total;
    document.getElementById('pendingItems').textContent = pending;
    document.getElementById('purchasedItems').textContent = purchased;
}

// Filter tabs
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        loadItems(currentFilter);
    });
});

// Submit item form
document.getElementById('itemForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const itemData = {
        item_name: document.getElementById('itemName').value,
        quantity: document.getElementById('itemQuantity').value || '1',
        category: document.getElementById('itemCategory').value,
        notes: document.getElementById('itemNotes').value
    };
    
    try {
        let response;
        if (editingItemId) {
            response = await fetch(`/api/shopping-items/${editingItemId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemData)
            });
        } else {
            response = await fetch('/api/shopping-items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(itemData)
            });
        }
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(data.message, 'success');
            modal.style.display = 'none';
            loadItems(currentFilter);
        } else {
            showMessage(data.message, 'error');
        }
    } catch (error) {
        showMessage('Error saving item', 'error');
    }
});

// Edit item
async function editItem(itemId) {
    try {
        const response = await fetch('/api/shopping-items?filter=all');
        const items = await response.json();
        const item = items.find(i => i.id === itemId);
        
        if (item) {
            editingItemId = itemId;
            document.getElementById('modalTitle').textContent = 'Edit Shopping Item';
            document.getElementById('itemName').value = item.item_name;
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemNotes').value = item.notes || '';
            
            modal.style.display = 'flex';
        }
    } catch (error) {
        showMessage('Error loading item', 'error');
    }
}

// Toggle item purchased status
async function toggleItem(itemId) {
    try {
        const response = await fetch(`/api/shopping-items/${itemId}/toggle`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            loadItems(currentFilter);
        }
    } catch (error) {
        showMessage('Error updating item', 'error');
    }
}

// Delete item
async function deleteItem(itemId) {
    if (!confirm('Are you sure you want to delete this item?')) return;
    
    try {
        const response = await fetch(`/api/shopping-items/${itemId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(data.message, 'success');
            loadItems(currentFilter);
        }
    } catch (error) {
        showMessage('Error deleting item', 'error');
    }
}

// Clear purchased items
document.getElementById('clearPurchasedBtn').addEventListener('click', async () => {
    if (!confirm('Are you sure you want to clear all purchased items?')) return;
    
    try {
        const response = await fetch('/api/shopping-items/clear-purchased', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(data.message, 'success');
            loadItems(currentFilter);
        }
    } catch (error) {
        showMessage('Error clearing purchased items', 'error');
    }
});

// Show message
function showMessage(text, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = text;
    messageDiv.className = `message ${type} show`;
    
    setTimeout(() => {
        messageDiv.classList.remove('show');
    }, 3000);
}

// Initialize
loadItems();
</script>
{% endblock %}
